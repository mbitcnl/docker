version: '3.8'

services:
  postgresql:
    image: postgres:15-alpine
    user: ${PUID}:${PGID}
    environment:
      - POSTGRES_USER=gitlab
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=gitlabhq_production
    volumes:
      - ${POSTGRES_DATA_PATH}:/var/lib/postgresql/data
    networks:
      - gitlab-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gitlab -d gitlabhq_production"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    user: ${PUID}:${PGID}
    volumes:
      - ${REDIS_DATA_PATH}:/data
    networks:
      - gitlab-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10

  gitlab:
    image: gitlab/gitlab-ce:latest
    environment:
      - GITLAB_ROOT_PASSWORD=${GITLAB_ROOT_PASSWORD}
      - GITLAB_OMNIBUS_CONFIG=external_url '${GITLAB_EXTERNAL_URL}';
        gitlab_rails['db_adapter']='postgresql';
        gitlab_rails['db_host']='postgresql';
        gitlab_rails['db_port']=5432;
        gitlab_rails['db_database']='gitlabhq_production';
        gitlab_rails['db_username']='gitlab';
        gitlab_rails['db_password']='${POSTGRES_PASSWORD}';
        gitlab_rails['redis_host']='redis';
        nginx['listen_addresses']=['0.0.0.0'];
        nginx['listen_port']=80;
        nginx['listen_https']=false;
        nginx['proxy_set_headers']={'X-Forwarded-Proto'=>'https','X-Forwarded-Ssl'=>'on','Host'=>'$$http_host'};
        gitlab_workhorse['listen_network']='tcp';
        gitlab_workhorse['listen_addr']='0.0.0.0:8181'
    volumes:
      - ${GITLAB_CONFIG_PATH}:/etc/gitlab
      - ${GITLAB_LOGS_PATH}:/var/log/gitlab
      - ${GITLAB_DATA_PATH}:/var/opt/gitlab
    networks:
      - gitlab-network
      - caddy-proxy
    labels:
      - "caddy=${GITLAB_DOMAIN}"
      - "caddy.reverse_proxy={{upstreams 80}}"
    depends_on:
      - postgresql
      - redis
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

networks:
  gitlab-network:
    external: true
    name: gitlab-network
  caddy-proxy:
    external: true
    name: caddy-proxy
    driver: overlay
