version: '3.8'

networks:
  zoraxy-net:
    driver: overlay
    attachable: true

services:
  zoraxy:
    image: zoraxydocker/zoraxy:latest
    networks:
      - zoraxy-net
    ports:
      - target: 80
        published: ${HTTP_PORT}
        mode: host
      - target: 443
        published: ${HTTPS_PORT}
        mode: host
      - target: 8000
        published: ${ADMIN_PORT}
        mode: host
    volumes:
      - ${CONFIG_PATH}:/opt/zoraxy/config/
      - ${DOCKER_SOCK}:/var/run/docker.sock:ro
      - ${LOCALTIME}:/etc/localtime:ro
    environment:
      - FASTGEOIP=true
      - DOCKER=true
      - MDNS=true
      - DOCKER_CLUSTER=true
      - NODE_ID={{.Node.ID}}
      - HOSTNAME={{.Node.Hostname}}
    deploy:
      mode: global
      endpoint_mode: dnsrr
      placement:
        constraints:
          - node.platform.os == linux
        preferences:
          - spread: node.id
      labels:
        - "swarm.proxy=true"
      restart_policy:
        condition: any
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first 